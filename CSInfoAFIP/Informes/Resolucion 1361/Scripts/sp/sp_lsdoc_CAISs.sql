SET QUOTED_IDENTIFIER ON 
GO
SET ANSI_NULLS ON 
GO

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_lsdoc_CAISs]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
drop procedure [dbo].[sp_lsdoc_CAISs]
GO







/*
delete proveedorcai
delete proveedor
sp_lsdoc_CAISs '@20030604,#@20030605,20-05392402-7#@20030620,20-06786179-6#@20030620,20-06799385-4#@20030620,20-08293079-6#@20030613,20-12550676-4#@20030613,20-12614926-4#@20030610,20-14621204-3#@20030627,20-14755975-6#@20030605,20-15253221-1#@20030613,20-16297577-4#@20030602,20-16672602-7#@20030626,20-16763080-5#@20030613,20-20413948-3#@20030610,20-21059912-7#@20030620,20-22852409-4#@20030605,20-25966497-8#@20030627,20-28589457-4#@20030620,23-05575126-9#@20030620,23-12550863-4#@20030611,23-16844021-9#@20030604,27-04299713-2#@20030604,27-13722848-9#@20030613,27-14296348-0#@20030604,27-14651999-2#@20030604,27-21836902-8#@20030620,30-50014411-0#@20030627,30-54087659-9#@20030605,30-55840499-6#@20030602,30-60447926-2#@20030624,30-62600060-2#@20030610,30-64140555-4#@20030620,30-64810148-8#@20030604,30-65704981-2#@20030603,30-66207410-8#@20030620,30-66877242-7#@20030627,30-67877449-5#@20030613,30-68148463-5#@20030610,30-68354602-6#@20030625,30-69054648-1#@20030613,30-69396403-9#@20030611,30-69671469-6#@20030603,30-70455672-8#@20030619,30-70721067-9#@20030620,30-70764946-8#@20030604,30-70769487-0#@20030612,30-70794509-1#@20030612,30-70794855-4#@20030619,30-70818250-4#@20030613,33-70817112-9#@20030627,1#@20030609,20-04016455-4#@20030613,20-04982465-4#@20030623,20-05558417-7#@20030630,20-06188779-3#@20030627,20-06811944-9#@20030627,20-07656383-8#@20030605,20-08110462-0#@20030630,20-08268529-5#@20030613,20-08627778-7#@20030620,20-11310313-3#@20030630,20-15224924-2#@20030610,20-15229343-8#@20030604,20-16310013-5#@20030623,20-20010205-4#@20030630,20-20534251-7#@20030624,23-05575126-9#@20030627,23-11353939-9#@20030627,23-13204461-9#@20030623,23-20341586-9#@20030620,24-06799508-9#@20030630,24-07752660-5#@20030624,27-04111255-2#@20030630,27-10110771-5#@20030610,27-10915846-7#@20030623,27-20530910-7#@20030630,30-50003691-1#@20030626,30-50123409-1#@20030630,30-50155507-6#@20030623,30-50383874-1#@20030623,30-50426416-1#@20030630,30-50524103-3#@20030623,30-51665694-4#@20030613,30-51669047-6#@20030630,30-51919548-4#@20030630,30-53199906-8#@20030630,30-53625919-4#@20030630,30-53636739-6#@20030624,30-54183784-8#@20030630,30-54411003-5#@20030627,30-55078148-0#@20030623,30-57334721-4#@20030623,30-57908814-8#@20030630,30-58004290-9#@20030630,30-58038288-2#@20030613,30-58838604-6#@20030604,30-59437435-1#@20030630,30-59601339-9#@20030630,30-59757063-1#@20030627,30-59893895-0#@20030623,30-60263267-5#@20030627,30-605547725-5#@20030630,30-60630195-9#@20030623,30-60655017-7#@20030613,30-62419224-5#@20030630,30-62495916-3#@20030625,30-62652115-7#@20030623,30-63341362-9#@20030613,30-63416590-4#@20030623,30-63945373-8#@20030609,30-65511620-2#@20030606,30-65901405-6#@20030612,30-65956375-0#@20030624,30-66136734-9#@20030630,30-66174060-0#@20030627,30-66877242-7#@20030630,30-66984494-4#@20030623,30-67333738-0#@20030630,30-67849077-2#@20030630,30-67881435-7#@20030613,30-67964040-9#@20030623,30-68638498-1#@20030626,30-68649805-7#@20030620,30-69078352-1#@20030630,30-69121544-6#@20030620,30-69229637-7#@20030630,30-69395950-7#@20030625,30-69421019-4#@20030611,30-69469031-5#@20030610,30-69636880-1#@20030606,30-69637715-0#@20030623,30-69831155-6#@20030610,30-70006825-7#@20030623,30-70453591-7#@20030627,30-70703682-2#@20030630,30-70710713-4#@20030630,30-70721392-9#@20030623,30-70752130-5#@20030623,30-70755135-2#@20030620,30-70802926-9#@20030620,33-50003806-9#@20030626,33-54174243-9#@20030613,33-67335529-9#@20030623,33-69237601-9#@20030623,33-69420139-9#@20030613,33-70794897-9#@20030620,55-000000005-0#'

*/
create procedure sp_lsdoc_CAISs (
  @@cuits  varchar(5000)
)
as

set nocount on

begin
  create table #tmpCuits(

    desde datetime,
    cuit varchar (25) COLLATE SQL_Latin1_General_CP1_CI_AI NULL,
    nrodoc varchar (25) COLLATE SQL_Latin1_General_CP1_CI_AI NULL
  )

  declare @sqlstmt varchar(8000)

  declare @n int
  declare @x int
  declare @c varchar

  set @x=0
  while len(@@cuits)>0 begin
    set @x = @x + 1
    set @sqlstmt = substring(@@cuits,1,2000)
    set @c = substring(@sqlstmt,len(@sqlstmt),1)
    set @n = 0

    while @c <> '#' begin
      set @n = @n +1
      set @c = substring(@sqlstmt,len(@sqlstmt)-@n,1)
    end

    set @sqlstmt = substring(@sqlstmt,1,len(@sqlstmt)-@n)
    set @@cuits = substring(@@cuits,len(@sqlstmt)+1,len(@@cuits))

    set @sqlstmt = replace(@sqlstmt,',', ''',''')
    set @sqlstmt = replace(@sqlstmt,'#', ''')'+char(10)+char(13))
    set @sqlstmt = replace(@sqlstmt,'@', 'insert #tmpCuits values(''') 

    execute (@sqlstmt)
    if @x >5 return
  end

  select proveedor.prov_id,
         TypeTask  = '',
         Nombre = prov_nombre,
         CUIT   = proveedor.prov_cuit,
         Fecha  = max(#tmpCuits.desde),
         Comprobante = nrodoc,
         Cargado = 0,
         dummy=''

  from proveedor, #tmpCuits, proveedorcai

  where proveedor.prov_cuit = #tmpCuits.cuit
        and proveedor.prov_id *= proveedorcai.prov_id

  group by proveedor.prov_id, proveedor.prov_nombre, proveedor.prov_cuit,nrodoc having max(isnull(provc_fechavto,'19900101'))<max(desde)

  order by Comprobante 

end
GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO
